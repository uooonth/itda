import React, { useState, useEffect } from 'react';
import '../css/nav.css';
import { NavLink, useLocation,useNavigate  } from 'react-router-dom'; 
import smileIcon from '../icons/smile.svg';
import bellIcon from '../icons/bell.svg';
import loginIcon from '../icons/login.svg';
import goProjectIcon from '../icons/goProject.svg';
import closeIcon from '../icons/close.svg';
import alarmIcon from '../icons/alarm.svg';
import chatIcon from '../icons/chat.svg';
import paperIcon from '../icons/paper.svg';
import starIcon from '../icons/star.svg';
import uploadIcon from '../icons/upload.svg';
import timerIcon from '../icons/timer.svg';
import Picker from 'emoji-picker-react';

function Navigation({ isLoggedIn, username }) {
  const location = useLocation();

  const [showProfilePopup, setShowProfilePopup] = useState(false);
  const [showAlarmPopup, setShowAlarmPopup] = useState(false);
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  const [selectedEmoji, setSelectedEmoji] = useState({ emoji: 'ü•∞' });

    // Ïú†Ï†Ä ÏïÑÏù¥Îîî
  const [userProfile, setUserProfile] = useState(null);
  function handleEmojiSelect(emojiObject) {
      setSelectedEmoji(emojiObject);
      setShowEmojiPicker(false); // Ïù¥Î™®ÏßÄ ÏÑ†ÌÉù ÌõÑ ÏÑ†ÌÉù Ï∞Ω Îã´Í∏∞
  }

  const [notifications, setNotifications] = useState([]);

  const toggleProfilePopup = () => setShowProfilePopup(!showProfilePopup);
  const toggleAlarmPopup = () => setShowAlarmPopup(!showAlarmPopup);
  const handleEmojiSelect = (emojiObject) => {
    setSelectedEmoji(emojiObject);
    setShowEmojiPicker(false);
  };

  const handleLogout = () => {
    localStorage.removeItem("access_token");
    window.location.href = "/";
  };

  // üî• Ïã§ÏãúÍ∞Ñ WebSocket ÏïåÎ¶º Ï∂îÍ∞Ä
  useEffect(() => {
    const ws = new WebSocket("ws://localhost:8008/ws/livechat/notification");

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      let notification;

      if (msg.type === "join") {
        notification = {
          id: Date.now(),
          type: "join",
          time: new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          projectName: msg.project_name,
          joinedUser: msg.joined_user
        };
      } else if (msg.type === "chat") {
        notification = {
          id: Date.now(),
          type: "chat",
          time: new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          projectName: msg.project_name
        };
      } else if (msg.type === "upload") {
        notification = {
          id: Date.now(),
          type: "upload",
          time: new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          fileName: msg.file_name,
          projectName: msg.project_name,
          uploader: msg.uploader
        };
      }

      setNotifications(prev => [notification, ...prev]);
    };


    ws.onclose = () => console.log("WebSocket closed");
    return () => ws.close();
  }, []);

    useEffect(() => {
    const ws = new WebSocket("ws://localhost:8008/ws/livechat/notification");

    ws.onopen = () => console.log("‚úÖ WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ");
    ws.onerror = (error) => console.error("‚ùå WebSocket Ïò§Î•ò:", error);
    ws.onclose = () => console.log("‚ùå WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å");

    ws.onmessage = (event) => {
      console.log("üì¶ ÏàòÏã†Îêú ÏõêÎ≥∏ Î©îÏãúÏßÄ:", event.data);
      try {
        const msg = JSON.parse(event.data);
        console.log("üß™ ÌååÏã± ÏÑ±Í≥µ Î©îÏãúÏßÄ:", msg);
      } catch (e) {
        console.error("üí• JSON ÌååÏã± Ïã§Ìå®:", e);
      }
    };

    return () => ws.close();
  }, []);

  useEffect(() => {
      const ws = new WebSocket("ws://127.0.0.1:8008/ws/livechat/notification");

      ws.onopen = () => console.log("‚úÖ WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ");
      ws.onerror = (error) => console.error("‚ùå WebSocket ÏóêÎü¨:", error);
      ws.onclose = () => console.log("‚ùå WebSocket Îã´Ìûò");
      
      return () => ws.close();
  }, []);

    /*-------------------------------------------------------------*/
    /*-----------------------     Ïä§ÎßàÏùºÌåù     ---------------------*/
    /*-------------------------------------------------------------*/
    const [userProjects, setUserProjects] = useState([]);
    const [loadingProjects, setLoadingProjects] = useState(false);

    const navigate = useNavigate();
    // ÌîÑÎ°úÏ†ùÌä∏Î°ú Ïù¥ÎèôÌïòÎäî Ìï®Ïàò
    const goToProject = (projectId) => {
      navigate(`/project/${projectId}`);
      setShowProfilePopup(false); // ÌåùÏóÖ Îã´Í∏∞
    };

    // ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑÍ≥º ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    useEffect(() => {
        const fetchAllData = async () => {
            if (!username) return;
            
            try {
                setLoadingProjects(true);
                
                // ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const [usersResponse, projectsResponse] = await Promise.all([
                    fetch(`http://localhost:8008/getUsers`),
                    fetch(`http://localhost:8008/users/${username}/projects`) // ÏÇ¨Ïö©ÏûêÏùò ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù
                ]);

                const usersData = await usersResponse.json();
                const filteringData = usersData.find(userData => userData.id === username);
                
                if (filteringData) {
                    setUserProfile(filteringData);
                } else {
                    console.error('user filtering fail');
                    setUserProfile(null);
                }

                // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                if (projectsResponse.ok) {
                    const projectsData = await projectsResponse.json();
                    setUserProjects(projectsData);
                } else {
                    console.error('ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®');
                    setUserProjects([]);
                }

            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Ìå®Ïπò Ïã§Ìå®:', error);
                setUserProjects([]);
            } finally {
                setLoadingProjects(false);
            }
        };

        fetchAllData();
    }, [username]);
    console.log("userProjects", userProjects);
    console.log("userProfile", userProfile);
    console.log("loadingProjects", loadingProjects);

  return (
    <div className="navigation">
        <div className="logo">itda</div>
        <div className="navLinks">
            <NavLink to="/home" className={`navLink ${location.pathname === '/home' ? 'active' : ''}`}>Home</NavLink>
            <NavLink to="/project" className={`navLink ${location.pathname === '/project' ? 'active' : ''}`}>Project</NavLink>
            <NavLink to="/profile" className={`navLink ${location.pathname === '/profile' ? 'active' : ''}`}>Profile</NavLink>
        </div>
        {isLoggedIn ? (
            <div className="userSection">
                <div className="userName">{userProfile?.name}Îãò</div>
                <img src={smileIcon} alt="Smile" className="icon" onClick={toggleProfilePopup} />
                <img src={bellIcon} alt="Bell" className="icon" onClick={toggleAlarmPopup} />
                
                {showProfilePopup && (
                    <div className="popup profilePopup">
                        <span className="close">
                            <img src={closeIcon} alt="close" className="icon" onClick={toggleProfilePopup} />
                        </span>

                        <div className="section">
                            <span className="popupUserName userName" onClick={() => setShowEmojiPicker(!showEmojiPicker)}>
                                {userProfile?.name}Îãò {selectedEmoji.emoji}
                            </span>
                            {showEmojiPicker && <Picker onEmojiClick={handleEmojiSelect} />}
                        </div>
                        
                        <div className="section">
                            <div className="content-nav">
                                <span className="email">
                                    {userProfile?.email || 'email@example.com'}
                                </span>
                                <span className="profileSettings">ÏÑ§Ï†ï</span>
                            </div>
                        </div>
                        
                        <div className="divider"></div>
                        
                        <div className="section">
                            <div className="title">Ï∞∏Ïó¨Ï§ëÏù∏ ÌîÑÎ°úÏ†ùÌä∏</div>
                            {loadingProjects ? (
                                <div className="content">
                                    <span style={{ color: '#999', fontSize: '14px' }}>Î°úÎî© Ï§ë...</span>
                                </div>
                            ) : userProjects.length > 0 ? (
                                <div className="projects-list">
                                    {userProjects.map((project, index) => (
                                        <div key={project.id || index} className="content" style={{ 
                                            marginBottom: '8px',
                                            cursor: 'pointer',
                                            padding: '4px 0',
                                            borderRadius: '4px',
                                            transition: 'background-color 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.backgroundColor = '#f5f5f5'}
                                        onMouseLeave={(e) => e.target.style.backgroundColor = 'transparent'}
                                        onClick={() => goToProject(project.project.project.id)}
                                        >
                                            <span style={{ flex: 1 }}>
                                                {project.project.project.name || 'ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ ÏóÜÏùå'}
                                            </span>
                                            <img src={goProjectIcon} alt="goProject" className="icon" />
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="content">
                                    <span style={{ color: '#999', fontSize: '14px' }}>
                                        Ï∞∏Ïó¨ Ï§ëÏù∏ ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§
                                    </span>
                                </div>
                            )}
                        </div>
                        
                        <div className="divider"></div>
                        <div className="logout" onClick={handleLogout}>Î°úÍ∑∏ÏïÑÏõÉ</div>
                    </div>
                )}

                {/* ÏïåÎ¶º ÌåùÏóÖÏùÄ Í∏∞Ï°¥ ÏΩîÎìú Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ */}
                {showAlarmPopup && (
                    <div className="popup alarmPopup">
                        {/* Í∏∞Ï°¥ ÏïåÎ¶º ÌåùÏóÖ ÏΩîÎìú */}
                    </div>
                )}
            </div>
        ) : (
            <div className="authSection">
                <NavLink to="/signupAgreement" className="signUp">
                    ÌöåÏõêÍ∞ÄÏûÖ
                </NavLink>
                <NavLink to="/login" className="navLink">
                    <button className="loginButton">
                        Î°úÍ∑∏Ïù∏
                        <img src={loginIcon} alt="login" className="icon" />
                    </button>
                </NavLink>
            </div>
        )}
    </div>
);
}

export default Navigation;
